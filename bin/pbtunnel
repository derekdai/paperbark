#!/bin/bash
include() {
    while [[ 0 != $# ]]; do
        source "$bin_dir/${1##*/}"
        shift
    done
}

pbtunnel_prepare() {
    set -o errexit

    pb_dir=$(readlink -f $BASH_SOURCE)
    pb_dir=${pb_dir%/bin/*}
    bin_dir="$pb_dir"/bin
    exec_file="${BASH_SOURCE##*/}"

    include utils
    include zfs
    include ssh
    include "$bin_dir"/pbtunnel-cmd-*
    trap pbtunnel_destroy EXIT
}

pbtunnel_destroy() {
    set +o errexit
    trap "" INT TERM

    cleanup_stack_pop_all
}

pbtunnel_exec() {
    ssh_tunnel_hello_back

    local -a cmd=($SSH_ORIGINAL_COMMAND)
    if [[ -z "${commands[${cmd[0]}]}" ]]; then
        echo unknown command: ${cmd[0]} >&2
        exit 1
    fi

    if ! pool_activate "$HOME/pbadmin"; then
        echo failed to activate pool >&2
        exit 1
    fi

    cmd_${cmd[0]//-/_}_prepare "${cmd[@]:1}"
    cmd_${cmd[0]//-/_}_exec
}

declare -A commands
declare -A config
pb_user="$1"

pbtunnel_prepare
pbtunnel_exec
