#!/bin/bash
commands['push']='upload snapshot onto server'
dep_add ssh mkfifo zfs sudo lbzip2 pv

push_help() {
    echo """
usage:
    $exec_file push [REMOTE] SNAPSHOT
          REMOTE    remote name
        SNAPSHOT    snapshot to upload to server
"""

    exit 0
}

cmd_push_prepare() {
    if [[ 0 == $# ]]; then
        push_help
    fi

    while [[ 0 != $# ]]; do
        case $1 in
            -h | --help)
                push_help
                ;;
            *)
                if [[ -z "$push_remote" ]] && [[ -f "$conf_dir/remotes/$1" ]]; then
                    push_remote="$1"
                elif [[ -z "$push_snapshot" ]]; then
                    if snapshot_exists "$1"; then
                        push_snapshot="$1"
                    else
                        echo snapshot does not exist: \'$1\'
                        exit 1
                    fi
                else
                    echo invalid argument: \'$1\'
                    exit 1
                fi
                ;;
        esac

        shift
    done

    if [[ -z "$push_remote" ]]; then
        pb_config_get 'default.remote' push_remote
    fi
    pb_remote_get "$push_remote" push_remote
    if [[ -z "$push_remote" ]]; then
        echo no remote specified
        exit 1
    fi

    if [[ -z "$push_snapshot" ]]; then
        echo no snapshot specified
        exit 1
    fi
}

# 98.7MB, 10s
#zfs send ${push_snapshots[0]} 2>/dev/null | lbzip2 -cz | pv -B 8m
# 111MB, 9s
#zfs send ${push_snapshots[0]} 2>/dev/null | pigz -c | pv -B 8m
# 112MB, 15s
#zfs send ${push_snapshots[0]} 2>/dev/null | gzip -c | pv -B 8m
# 98.8MB, 17s
#zfs send ${push_snapshots[0]} 2>/dev/null | pbzip2 -cz | pv -B 8m
# 73.3MB, 154s
#zfs send ${push_snapshots[0]} 2>/dev/null | xz -cz | pv -B 8m
# 98.8MB, 17s
#zfs send ${push_snapshots[0]} 2>/dev/null | pbzip2 -cz -9 | pv -B 8m
# 101MB, 16s
#zfs send ${push_snapshots[0]} 2>/dev/null | pbzip2 -cz -5 | pv -B 8m
# 111MB, 21s
#zfs send ${push_snapshots[0]} 2>/dev/null | pigz -9 -c | pv -B 8m
# 73.2MB, 152s
#zfs send ${push_snapshots[0]} 2>/dev/null | lzma -cz | pv -B 8m
# 156MB, 2s
#zfs send ${push_snapshots[0]} 2>/dev/null | lzop -c | pv -B 8m
# 154MB, 3s
#zfs send ${push_snapshots[0]} 2>/dev/null | lzop -c | lzop -c | pv -B 8m
# 156MB, 2s
#zfs send ${push_snapshots[0]} 2>/dev/null | lzop -5 -c | pv -B 8m
# 123MB, 71s
#zfs send ${push_snapshots[0]} 2>/dev/null | lzop -8 -c | pv -B 8m
cmd_push_exec() {
    ssh_tunnel_create "$push_remote" 8 9 "push"

    # construct snapshot list
    snapshot="${_zfs_snap_id_fs_map[$push_snapshot]}@$push_snapshot"
    snapshots=("$snapshot")
    while [[ "${_zfs_snap_deps[$snapshot]}" ]]; do
        snapshot="${_zfs_snap_deps[$snapshot]}"
        snapshots=("${snapshot}" "${snapshots[@]}")
    done

    # exchange snapshot list
    echo "${snapshots[@]}" >&9
    read line <&8
    snapshots=($line)

    if (( 0 < ${#snapshots[@]} )); then
        if ! snapshot_has_parent ${snapshots[0]}; then
            snapshot_send ${snapshots[0]} >&9
        else
            snapshot_get_parent ${snapshots[0]} snapshot_parent
            snapshot_send_increment $snapshot_parent ${snapshots[0]} >&9
        fi

        for (( i=0; i<${#snapshots[@]}-1; ++i )); do
            snapshot_send_increment ${snapshots[$i]} ${snapshots[$i+1]} >&9
        done
    fi

    echo all snapshots sent
}
