#!/bin/bash
commands['move']='rename snapshot'
command_alias['mv']='move'

move_help() {
    echo """
usage:
    $exec_file move|mv OLD NEW
        OLD    origin snapshot id
        NEW    new snapshot id
"""

    exit 0
}

cmd_move_prepare() {
    while [[ 0 != $# ]]; do
        case $1 in
            -h | --help)
                move_help
                ;;
            *)
                if [[ -z "$move_old_id" ]]; then
                    move_old_id="$1"
                elif [[ -z "$move_new_id" ]]; then
                    move_new_id="$1"
                else
                    echo invalid argument: $1
                    move_help
                fi
                ;;
        esac

        shift
    done

    if [[ -z "$move_old_id" ]]; then
        echo old snapshot id not specified
        move_help
    elif [[ -z "$move_new_id" ]]; then
        echo new snapshot id not specified
        move_help
    fi

    snapshot_id_add_version "$move_old_id" latest move_old_id
    snapshot_id_add_version "$move_new_id" latest move_new_id
}

cmd_move_exec() {
    if ! snapshot_exists "$move_old_id" move_old_dataset; then
        echo snapshot does not exist: $move_old_id
        move_help
        exit 1
    fi

    zfs rename "$move_old_dataset" "${move_old_dataset%@*}@$move_new_id"
}
