#!/bin/bash
pbtunnel_destroy() {
    set +o errexit
    trap "" INT TERM

    cleanup_stack_pop_all
}

pbtunnel_exec() {
    PB_USER="$1"; shift

    ssh_tunnel_hello_back

    local -a cmd=($SSH_ORIGINAL_COMMAND)
    if [[ -z "${commands[$cmd]}" ]]; then
        echo unknown command: $cmd >&2
        exit 1
    fi

    if ! pool_activate "$HOME/pbadmin"; then
        echo failed to activate pool >&2
        exit 1
    fi

    cmd_${cmd[0]//-/_}_prepare "${cmd[@]:1}"
    cmd_${cmd[0]//-/_}_exec
}
